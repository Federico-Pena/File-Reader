import { createRequire } from "node:module"; const require = createRequire(import.meta.url);

// src/middlewares/queueMiddleware.ts
var ProcessQueue = class {
  queue = [];
  running = 0;
  maxConcurrent;
  constructor(maxConcurrent) {
    this.maxConcurrent = maxConcurrent;
  }
  add(req, res, next) {
    const task = { req, res, next };
    this.queue.push(task);
    this.runNext();
  }
  runNext() {
    if (this.running >= this.maxConcurrent) return;
    const task = this.queue.shift();
    if (!task) return;
    this.running++;
    const { req, res, next } = task;
    const release = () => {
      this.running--;
      res.removeListener("close", release);
      res.removeListener("finish", release);
      this.runNext();
    };
    res.on("close", release);
    res.on("finish", release);
    next();
  }
};
var sseQueue = new ProcessQueue(2);
var queueMiddleware = (req, res, next) => {
  console.log("queueMiddleware", req.url);
  sseQueue.add(req, res, next);
};
export {
  ProcessQueue,
  queueMiddleware
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vc3JjL21pZGRsZXdhcmVzL3F1ZXVlTWlkZGxld2FyZS50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IHR5cGUgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSAnZXhwcmVzcydcclxuXHJcbnR5cGUgVGFzayA9IHtcclxuICByZXE6IFJlcXVlc3RcclxuICByZXM6IFJlc3BvbnNlXHJcbiAgbmV4dDogTmV4dEZ1bmN0aW9uXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBQcm9jZXNzUXVldWUge1xyXG4gIHByaXZhdGUgcXVldWU6IFRhc2tbXSA9IFtdXHJcbiAgcHJpdmF0ZSBydW5uaW5nID0gMFxyXG4gIHByaXZhdGUgcmVhZG9ubHkgbWF4Q29uY3VycmVudDogbnVtYmVyXHJcblxyXG4gIGNvbnN0cnVjdG9yKG1heENvbmN1cnJlbnQ6IG51bWJlcikge1xyXG4gICAgdGhpcy5tYXhDb25jdXJyZW50ID0gbWF4Q29uY3VycmVudFxyXG4gIH1cclxuXHJcbiAgYWRkKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XHJcbiAgICBjb25zdCB0YXNrOiBUYXNrID0geyByZXEsIHJlcywgbmV4dCB9XHJcbiAgICB0aGlzLnF1ZXVlLnB1c2godGFzaylcclxuICAgIHRoaXMucnVuTmV4dCgpXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJ1bk5leHQoKSB7XHJcbiAgICBpZiAodGhpcy5ydW5uaW5nID49IHRoaXMubWF4Q29uY3VycmVudCkgcmV0dXJuXHJcbiAgICBjb25zdCB0YXNrID0gdGhpcy5xdWV1ZS5zaGlmdCgpXHJcbiAgICBpZiAoIXRhc2spIHJldHVyblxyXG5cclxuICAgIHRoaXMucnVubmluZysrXHJcbiAgICBjb25zdCB7IHJlcSwgcmVzLCBuZXh0IH0gPSB0YXNrXHJcblxyXG4gICAgLy8gSW1wb3J0YW50ZTogZGV0ZWN0YXIgY3VhbmRvIGxhIHJlc3B1ZXN0YSBzZSBjaWVycmEgcGFyYSBsaWJlcmFyIHNsb3RcclxuICAgIGNvbnN0IHJlbGVhc2UgPSAoKSA9PiB7XHJcbiAgICAgIHRoaXMucnVubmluZy0tXHJcbiAgICAgIHJlcy5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCByZWxlYXNlKVxyXG4gICAgICByZXMucmVtb3ZlTGlzdGVuZXIoJ2ZpbmlzaCcsIHJlbGVhc2UpXHJcbiAgICAgIHRoaXMucnVuTmV4dCgpXHJcbiAgICB9XHJcblxyXG4gICAgcmVzLm9uKCdjbG9zZScsIHJlbGVhc2UpXHJcbiAgICByZXMub24oJ2ZpbmlzaCcsIHJlbGVhc2UpXHJcblxyXG4gICAgbmV4dCgpXHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBzc2VRdWV1ZSA9IG5ldyBQcm9jZXNzUXVldWUoMikgLy8gbVx1MDBFMXhpbW8gMiB1c3VhcmlvcyBjb25jdXJyZW50ZXNcclxuZXhwb3J0IGNvbnN0IHF1ZXVlTWlkZGxld2FyZSA9IChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xyXG4gIGNvbnNvbGUubG9nKCdxdWV1ZU1pZGRsZXdhcmUnLCByZXEudXJsKVxyXG5cclxuICBzc2VRdWV1ZS5hZGQocmVxLCByZXMsIG5leHQpXHJcbn1cclxuIl0sCiAgIm1hcHBpbmdzIjogIjs7O0FBUU8sSUFBTSxlQUFOLE1BQW1CO0FBQUEsRUFDaEIsUUFBZ0IsQ0FBQztBQUFBLEVBQ2pCLFVBQVU7QUFBQSxFQUNEO0FBQUEsRUFFakIsWUFBWSxlQUF1QjtBQUNqQyxTQUFLLGdCQUFnQjtBQUFBLEVBQ3ZCO0FBQUEsRUFFQSxJQUFJLEtBQWMsS0FBZSxNQUFvQjtBQUNuRCxVQUFNLE9BQWEsRUFBRSxLQUFLLEtBQUssS0FBSztBQUNwQyxTQUFLLE1BQU0sS0FBSyxJQUFJO0FBQ3BCLFNBQUssUUFBUTtBQUFBLEVBQ2Y7QUFBQSxFQUVRLFVBQVU7QUFDaEIsUUFBSSxLQUFLLFdBQVcsS0FBSyxjQUFlO0FBQ3hDLFVBQU0sT0FBTyxLQUFLLE1BQU0sTUFBTTtBQUM5QixRQUFJLENBQUMsS0FBTTtBQUVYLFNBQUs7QUFDTCxVQUFNLEVBQUUsS0FBSyxLQUFLLEtBQUssSUFBSTtBQUczQixVQUFNLFVBQVUsTUFBTTtBQUNwQixXQUFLO0FBQ0wsVUFBSSxlQUFlLFNBQVMsT0FBTztBQUNuQyxVQUFJLGVBQWUsVUFBVSxPQUFPO0FBQ3BDLFdBQUssUUFBUTtBQUFBLElBQ2Y7QUFFQSxRQUFJLEdBQUcsU0FBUyxPQUFPO0FBQ3ZCLFFBQUksR0FBRyxVQUFVLE9BQU87QUFFeEIsU0FBSztBQUFBLEVBQ1A7QUFDRjtBQUVBLElBQU0sV0FBVyxJQUFJLGFBQWEsQ0FBQztBQUM1QixJQUFNLGtCQUFrQixDQUFDLEtBQWMsS0FBZSxTQUF1QjtBQUNsRixVQUFRLElBQUksbUJBQW1CLElBQUksR0FBRztBQUV0QyxXQUFTLElBQUksS0FBSyxLQUFLLElBQUk7QUFDN0I7IiwKICAibmFtZXMiOiBbXQp9Cg==
